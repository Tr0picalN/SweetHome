<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <link type="text/css" rel="stylesheet" href="../css/bootstrap.min.css" />
  <link type="text/css" rel="stylesheet" href="../css/bootstrap-vue.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
</head>
<body>
  <div id="app">
    <b-container>
      <b-row class="vh-100" align-v="center" align-h="center">
        <b-col style="max-width: 600px;">
          <b-card no-body header="네트워크">
            <b-card-text>
              <b-list-group flush v-for="(network, i) in networks" :key="i">
                <b-list-group-item button @click="onClickItem(i)" v-show="!network.hidden">
                  <div class="d-flex w-100 justify-content-between">
                    <p class="mb-1">{{ network.ssid }}</h5>
                    <b-icon icon="lock-fill" v-show="network.secure != 7"/>
                    <div v-if="network.rssi <= -30 && network.rssi >= -80">
                      <b-icon icon="wifi" />
                    </div>
                    <div v-else-if="network.rssi <= -80 && network.rssi >= -90">
                      <b-icon icon="wifi2" />
                    </div>
                    <div v-else>
                      <b-icon icon="wifi1" />
                    </div>
                  </div>
                </b-list-group-item>  
              </b-list-group>
            </b-card-text>
          </b-card>
          <b-modal id="modal" v-model="modal" centered="true" :title="title + '의 비밀번호 입력'" @ok="handleOk" @cancel="reset" @hidden="reset">
            <b-form ref="form" @submit.stop.prevent="onSubmit">
              <b-form-group label="비밀번호" label-for="intput-password" invalid-feedback="비밀번호를 입력해주세요." :state="passwordState">
                <b-form-input type="password" id="intput-password" v-model="password" :state="passwordState" required />
              </b-form-group>
            </b-form>
            <template #modal-footer="{ ok, cancel }">
              <b-button variant="primary" @click="ok()">연결</b-button>
              <b-button @click="cancel()">취소</b-button>
            </template>
          </b-modal>
        </b-col>
      </b-row>
    </b-container>
  </div>

  <script type="text/javascript" src="../script/vue.min.js"></script>
  <script type="text/javascript" src="../script/bootstrap-vue.min.js"></script>
  <script type="text/javascript" src="../script/bootstrap-vue-icons.min.js"></script>
  <script type="text/javascript" src="../script/axios.min.js"></script>
  <script>
    new Vue({
      el: '#app',

      created () {
        this.onScan()
        
        this.polling = setInterval(() => {
          this.onScan()
        }, 5000)
      },

      beforeDestroy () {
        clearInterval(this.polling)
      },

      data: () => ({
        polling: null,
        modal: false,
        title: '',
        selectedNetwork: null,
        ssid: '',
        password: '',
        passwordState: null,
        networks: [
          {"rssi":-93,"ssid":"[floor a/c] Samsung","bssid":"28:6D:97:8D:6B:F3","channel":1,"secure":4,"hidden":false},
          {"rssi":-85,"ssid":"t-broadCE91","bssid":"54:D1:63:2F:CE:97","channel":1,"secure":8,"hidden":false},
          {"rssi":-89,"ssid":"U+Net91DB","bssid":"18:C5:01:80:91:DA","channel":1,"secure":4,"hidden":false},
          {"rssi":-82,"ssid":"t-broad7E35","bssid":"54:D1:63:27:7E:3B","channel":1,"secure":8,"hidden":false},
          {"rssi":-54,"ssid":"DIRECT-F8-SA SL-J3560FW","bssid":"C8:D3:FF:89:E4:FA","channel":3,"secure":4,"hidden":false},
          {"rssi":-51,"ssid":"KT_GiGA_2G_Wave2_D7B7","bssid":"B4:A9:4F:30:D7:BB","channel":3,"secure":8,"hidden":false},
          {"rssi":-47,"ssid":"AndroidHotspot","bssid":"8E:D3:25:F9:D2:2E","channel":6,"secure":7,"hidden":false},
          {"rssi":-72,"ssid":"tsubasa","bssid":"58:86:94:00:5C:74","channel":6,"secure":4,"hidden":false},
          {"rssi":-92,"ssid":"SK_WiFi3EF2","bssid":"00:08:52:2E:3E:F3","channel":1,"secure":8,"hidden":false},
          {"rssi":-86,"ssid":"U+Net8D53(C5-1)","bssid":"00:40:5A:85:8D:51","channel":8,"secure":4,"hidden":false},
          {"rssi":-88,"ssid":"U+zone","bssid":"00:40:5A:85:8D:52","channel":8,"secure":255,"hidden":false},
          {"rssi":-69,"ssid":"olleh_WiFi_33FF","bssid":"00:07:89:47:34:02","channel":9,"secure":8,"hidden":false},
          {"rssi":-69,"ssid":"U+Net259D","bssid":"88:3C:1C:92:25:9C","channel":10,"secure":4,"hidden":false},
          {"rssi":-89,"ssid":"jongtae","bssid":"88:36:6C:87:99:70","channel":10,"secure":7,"hidden":false},
          {"rssi":-91,"ssid":"KT_GiGA_2G_Wave2_B208","bssid":"00:07:89:99:B2:0B","channel":1,"secure":8,"hidden":false}
          ]
      }),

      methods: {
        onSubmit () {
          if (!this.checkFormValidity()) {
            return
          }

          axios.post('/connect', {
            ssid: this.ssid,
            password: this.password
          })
            .then(res=> {

            })
            .catch(err => {

            })

          this.$nextTick(() => {
            this.$bvModal.hide('modal')
          })
        },

        onScan () {
          axios.get('/scan')
            .then(res => {
              this.networks = res.data
            })
            .catch(err => {
              console.log(err)
            })
        },

        onClickItem (i) {
          if (!this.modal) {
            this.selectedNetwork = i
            this.title = this.networks[i].ssid
            this.ssid = this.networks[i].ssid
            this.modal = !this.modal
          }
        },

        checkFormValidity () {
          const valid = this.$refs.form.checkValidity()
          this.passwordState = valid
          return valid
        },

        handleOk (e) {
          e.preventDefault()
          this.onSubmit()
        },

        reset () {
          this.password = ''
          this.passwordState = null
        }
      }
    })
  </script>
</body>
</html>